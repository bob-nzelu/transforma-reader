name: Build Transforma Reader

on:
  push:
    branches: [main, develop, 'claude/**']
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest

    steps:
      - name: Checkout Transforma Reader
        uses: actions/checkout@v4

      - name: Setup MSBuild
        uses: microsoft/setup-msbuild@v2

      - name: Cache SumatraPDF source
        id: cache-sumatra
        uses: actions/cache@v4
        with:
          path: sumatrapdf
          key: sumatrapdf-3.5.2rel-v1

      - name: Clone SumatraPDF source
        if: steps.cache-sumatra.outputs.cache-hit != 'true'
        run: |
          git clone --depth 1 --branch 3.5.2rel https://github.com/sumatrapdfreader/sumatrapdf.git sumatrapdf
        shell: pwsh

      - name: Copy Helium source into SumatraPDF tree
        run: |
          Copy-Item -Recurse -Force "src/helium" "sumatrapdf/src/helium"
          Copy-Item -Force "src/patches/SumatraIntegration.cpp" "sumatrapdf/src/SumatraIntegration.cpp"

          Write-Host "Helium files copied:"
          Get-ChildItem "sumatrapdf/src/helium" | ForEach-Object { Write-Host "  $_" }
          Write-Host "  sumatrapdf/src/SumatraIntegration.cpp"
        shell: pwsh

      - name: Patch SumatraPDF project to include Helium
        run: |
          $vcxproj = "sumatrapdf/vs2022/SumatraPDF.vcxproj"
          [xml]$xml = Get-Content $vcxproj

          $nsUri = "http://schemas.microsoft.com/developer/msbuild/2003"
          $ns = New-Object System.Xml.XmlNamespaceManager($xml.NameTable)
          $ns.AddNamespace("ms", $nsUri)

          # --- 1. Add Helium .cpp files to the ClCompile ItemGroup ---
          $compileGroup = $xml.SelectSingleNode("//ms:ItemGroup[ms:ClCompile]", $ns)
          if (-not $compileGroup) {
            Write-Error "Could not find ClCompile ItemGroup in vcxproj"
            exit 1
          }

          $heliumCppFiles = @(
            "..\src\helium\HeliumController.cpp",
            "..\src\helium\RelayClient.cpp",
            "..\src\helium\SessionToken.cpp",
            "..\src\helium\InvoiceRouter.cpp",
            "..\src\helium\DuplicateCache.cpp",
            "..\src\SumatraIntegration.cpp"
          )

          foreach ($file in $heliumCppFiles) {
            $elem = $xml.CreateElement("ClCompile", $nsUri)
            $elem.SetAttribute("Include", $file)
            $compileGroup.AppendChild($elem) | Out-Null
            Write-Host "  Added ClCompile: $file"
          }

          # --- 2. Add Helium .h files to ClInclude ItemGroup ---
          $includeGroup = $xml.SelectSingleNode("//ms:ItemGroup[ms:ClInclude]", $ns)
          if ($includeGroup) {
            $heliumHeaders = @(
              "..\src\helium\HeliumController.h",
              "..\src\helium\RelayClient.h",
              "..\src\helium\SessionToken.h",
              "..\src\helium\InvoiceRouter.h",
              "..\src\helium\DuplicateCache.h"
            )
            foreach ($file in $heliumHeaders) {
              $elem = $xml.CreateElement("ClInclude", $nsUri)
              $elem.SetAttribute("Include", $file)
              $includeGroup.AppendChild($elem) | Out-Null
            }
            Write-Host "  Added ClInclude headers"
          }

          # --- 3. Add winhttp.lib and crypt32.lib to link dependencies ---
          $linkDeps = $xml.SelectNodes("//ms:ItemDefinitionGroup/ms:Link/ms:AdditionalDependencies", $ns)
          $libsAdded = 0
          foreach ($dep in $linkDeps) {
            $current = $dep.InnerText
            if ($current -notmatch 'winhttp\.lib') {
              $dep.InnerText = "winhttp.lib;crypt32.lib;$current"
              $libsAdded++
            }
          }
          Write-Host "  Added link libraries to $libsAdded configurations"

          # --- Save patched project ---
          $xml.Save((Resolve-Path $vcxproj).Path)
          Write-Host "Successfully patched $vcxproj"
        shell: pwsh

      - name: Build Release x64
        run: |
          msbuild sumatrapdf/vs2022/SumatraPDF.sln /p:Configuration=Release /p:Platform=x64 /m /v:normal
        shell: pwsh

      - name: Package artifact
        run: |
          New-Item -ItemType Directory -Force -Path artifact | Out-Null

          # SumatraPDF Release x64 output goes to out/rel64/
          $exe = Get-ChildItem -Recurse -Filter "SumatraPDF.exe" -Path "sumatrapdf/out" -ErrorAction SilentlyContinue |
                 Select-Object -First 1

          if (-not $exe) {
            # Fallback: search entire build tree
            $exe = Get-ChildItem -Recurse -Filter "SumatraPDF.exe" -Path "sumatrapdf" -ErrorAction SilentlyContinue |
                   Where-Object { $_.DirectoryName -match "Release|rel" } |
                   Select-Object -First 1
          }

          if ($exe) {
            Copy-Item $exe.FullName "artifact/TransformaReader.exe"
            $sizeMB = [math]::Round($exe.Length / 1MB, 2)
            Write-Host "Packaged: $($exe.FullName) -> artifact/TransformaReader.exe ($sizeMB MB)"
          } else {
            Write-Error "SumatraPDF.exe not found after build. Build output:"
            Get-ChildItem -Recurse -Path "sumatrapdf/out" -ErrorAction SilentlyContinue |
              ForEach-Object { Write-Host $_.FullName }
            exit 1
          }
        shell: pwsh

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: TransformaReader-x64
          path: artifact/TransformaReader.exe
          retention-days: 30
